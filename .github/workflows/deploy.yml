name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DB_USER,DB_PASSWORD,DB_NAME,JWT_SECRET,ADMIN_SECRET,FRONTEND_URL
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            git pull origin main

            # Write .env from GitHub Secrets
            printf 'DB_USER=%s\nDB_PASSWORD=%s\nDB_NAME=%s\nJWT_SECRET=%s\nADMIN_SECRET=%s\nFRONTEND_URL=%s\n' \
              "$DB_USER" "$DB_PASSWORD" "$DB_NAME" "$JWT_SECRET" "$ADMIN_SECRET" "$FRONTEND_URL" > .env

            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans
            docker image prune -f
